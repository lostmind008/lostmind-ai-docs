---
title: "LostMindAI-TurboRepo"
description: "This file provides guidance to Claude Code (claude.ai/code) when working with code in this repository."
category: "documentation"
project: "LostMind AI - Project Documentation"
lastUpdated: "2025-09-21"
tags: "documentation,ai-services"
---

# Google IAM Integration Example

This document shows how to use the Google IAM authentication system for service-to-service communication between Next.js apps and FastAPI services.

## FastAPI Service Configuration

The FastAPI service automatically supports Google IAM authentication through the updated middleware.

### Environment Variables
```bash
# Google Cloud Configuration
GOOGLE_CLOUD_PROJECT=coral-muse-469919-m0
GCP_PROJECT_ID=coral-muse-469919-m0
GOOGLE_APPLICATION_CREDENTIALS=/path/to/service-account-key.json

# Authentication Configuration
REQUIRE_AUTH=true
JWT_SECRET=your-jwt-secret
```

### Service Account Setup
1. Create a service account in Google Cloud Console
2. Download the service account key file
3. Set the `GOOGLE_APPLICATION_CREDENTIALS` environment variable

## Next.js Client Usage

### Basic Usage in API Routes

```typescript
// app/api/ai/generate/route.ts
import { NextRequest, NextResponse } from 'next/server'
import { withGoogleIAMAuth } from '@lostmind/auth'

export async function POST(request: NextRequest) {
  try {
    const { prompt } = await request.json()
    
    // Use Google IAM authentication to call FastAPI service
    const result = await withGoogleIAMAuth(
      process.env.AI_COMPUTE_SERVICE_URL!,
      async (client) => {
        return client.post('/generate/text', {
          prompt,
          temperature: 0.7,
          max_tokens: 1000
        })
      }
    )

    return NextResponse.json(result)
    
  } catch (error) {
    console.error('AI generation failed:', error)
    return NextResponse.json(
      { error: 'AI generation failed' },
      { status: 500 }
    )
  }
}
```

### Advanced Usage with Custom Client

```typescript
// lib/ai-service-client.ts
import { createGoogleIAMClient } from '@lostmind/auth'

class AIServiceClient {
  private iamClient = createGoogleIAMClient({
    projectId: process.env.GOOGLE_CLOUD_PROJECT!,
    targetAudience: process.env.AI_COMPUTE_SERVICE_URL,
  })

  async generateText(prompt: string, options = {}) {
    const client = await this.iamClient.createAuthenticatedClient(
      process.env.AI_COMPUTE_SERVICE_URL!
    )

    return client.post('/generate/text', {
      prompt,
      ...options
    })
  }

  async processDocument(file: File) {
    const client = await this.iamClient.createAuthenticatedClient(
      process.env.AI_COMPUTE_SERVICE_URL!
    )

    const formData = new FormData()
    formData.append('file', file)

    return client.fetch('/process/file', {
      method: 'POST',
      body: formData,
      headers: {
        // Don't set Content-Type for FormData, let browser handle it
      }
    })
  }

  async verifyConnection() {
    const isValid = await this.iamClient.verifyToken()
    console.log('IAM token valid:', isValid)
    return isValid
  }
}

export const aiServiceClient = new AIServiceClient()
```

### Usage in App Components (Server Components)

```typescript
// app/ai-chat/page.tsx
import { aiServiceClient } from '@/lib/ai-service-client'

export default async function AIChatPage() {
  // Verify connection on page load
  const connectionValid = await aiServiceClient.verifyConnection()
  
  if (!connectionValid) {
    return <div>Service authentication failed</div>
  }

  return (
    <div>
      <h1>AI Chat</h1>
      {/* Your chat component */}
    </div>
  )
}
```

### Client-Side Usage (Client Components)

```typescript
// components/AIChat.tsx
'use client'
import { useState } from 'react'

export default function AIChat() {
  const [response, setResponse] = useState('')
  const [loading, setLoading] = useState(false)

  const handleSubmit = async (prompt: string) => {
    setLoading(true)
    try {
      // Call your API route which handles IAM authentication
      const res = await fetch('/api/ai/generate', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
        },
        body: JSON.stringify({ prompt }),
      })

      if (!res.ok) throw new Error('Generation failed')
      
      const result = await res.json()
      setResponse(result.message)
      
    } catch (error) {
      console.error('Error:', error)
      setResponse('Error generating response')
    } finally {
      setLoading(false)
    }
  }

  // Your component JSX...
}
```

## Security Features

### Automatic Token Management
- Tokens are cached and automatically refreshed before expiration
- Built-in retry logic for expired tokens
- Secure storage in memory (not localStorage)

### Service Account Validation
- FastAPI service validates Google IAM tokens
- Service accounts get "enterprise" tier access
- User accounts get "professional" tier access
- Proper audience validation

### Error Handling
```typescript
try {
  const result = await withGoogleIAMAuth(serviceUrl, async (client) => {
    return client.post('/api/endpoint', data)
  })
} catch (error) {
  if (error.message.includes('401')) {
    // Authentication failed
    console.error('IAM authentication failed:', error)
  } els

---
*This content was automatically extracted from LostMind AI - Project Documentation. For the most up-to-date information, refer to the source project.*
